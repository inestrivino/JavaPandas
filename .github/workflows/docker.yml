name: Docker

on: 
  push:
    branches: 
    - main

#This worflow builds and pushes the demo of our project defined in the javapandas-demo dockerfile

jobs:
  build-and-push: 
    runs-on: ubuntu-latest
    permissions: 
      content: read
      packages: write
    
    build-and-push:
    #First we check that everything went well during the maven workflow
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    #We download the report generated by it
    - name: Download Coverage Artifact
      uses: actions/download-artifact@v3
      with:
        name: coverage-report
        path: coverage-report

    #We check the coverage according to the jacoco report
    - name: Check Code Coverage
      id: check_coverage
      run: |
        COVERAGE=$(cat coverage-report/coverage.txt)
        echo "Code coverage is $COVERAGE%"
        echo "coverage=$COVERAGE" >> $GITHUB_ENV

    #We set up docker Buildx so we can build images
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    #We login to GitHub container
    #Why we use container instead of packages: GHCR is a service provided by GitHub specifically for hosting and managing Docker container images. It has better integration of docker-specific tools.
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    #If the coverage is satisfactory, we build the javapandas-demo dockerfile
    - name: Build Docker Image
      if: env.coverage >= 80
      run: |
        docker build -t ghcr.io/inestrivino/javapandas-demo:latest .

    #If the coverage is satisfactory, we push the build image
    - name: Push Docker Image
      if: env.coverage >= 80
      run: |
        docker push ghcr.io/inestrivino/javapandas-demo:latest

    #If the coverage is satisfactory, we run the pushed image
    - name: Run Docker Demo
      if: env.coverage >= 80
      run: |
        docker run --rm ghcr.io/inestrivino/javapandas-demo:latest